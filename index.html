<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Roblox Revival</title>
  <style>
    body { font-family: Arial; margin:0; background:#f4f4f4; }
    header { background:#222; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    #menu { width:200px; background:#333; color:#fff; height:100vh; position:fixed; top:0; left:0; padding:20px; }
    #menu button { display:block; width:100%; margin:10px 0; padding:10px; background:#444; color:#fff; border:none; cursor:pointer; border-radius:8px; }
    #menu button:hover { background:#666; }
    #content { margin-left:220px; padding:20px; }
    .item { border:1px solid #ccc; background:#fff; margin:10px; padding:10px; display:inline-block; width:200px; vertical-align:top; border-radius:8px; text-align:center; }
    .item.agotado { background:#ddd; color:#666; }
    .btn { padding:5px 10px; margin:5px; border:none; cursor:pointer; border-radius:6px; }
    .btn-buy { background:#28a745; color:white; }
    .btn-delete { background:#dc3545; color:white; }
    .btn-edit { background:#007bff; color:white; }
    .btn-friend { background:#17a2b8; color:white; }
    #adminPanel { display:none; position:fixed; top:50px; right:50px; background:white; padding:20px; border:2px solid #000; border-radius:8px; width:350px; max-height:500px; overflow-y:auto; }
    #loginArea, #registerArea { margin:50px auto; width:300px; padding:20px; background:#fff; border:1px solid #ccc; border-radius:10px; }
    input { width:90%; padding:8px; margin:5px 0; }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
<header>
  <h2>Roblox Revival</h2>
  <div id="robuxDisplay" style="display:none;">üí∞ Robux: <span id="robuxAmount">0</span></div>
</header>

<div id="menu" style="display:none;">
  <button onclick="loadMarketplace()">Marketplace</button>
  <button onclick="loadProfile()">Profile</button>
  <button onclick="loadFriends()">Friends</button>
  <button onclick="logout()">Cerrar Sesi√≥n</button>
</div>

<div id="content">
  <div id="loginArea">
    <h3>Iniciar Sesi√≥n</h3>
    <input id="loginUser" placeholder="Usuario"><br>
    <input id="loginPass" type="password" placeholder="Contrase√±a"><br>
    <button onclick="login()">Entrar</button>
    <p>¬øNo tienes cuenta? <a href="#" onclick="showRegister()">Registrarse</a></p>
  </div>

  <div id="registerArea" style="display:none;">
    <h3>Registrarse</h3>
    <input id="regUser" placeholder="Usuario"><br>
    <input id="regPass" type="password" placeholder="Contrase√±a"><br>
    <button onclick="register()">Registrar</button>
    <p>¬øYa tienes cuenta? <a href="#" onclick="showLogin()">Iniciar Sesi√≥n</a></p>
  </div>
</div>

<!-- Admin Panel -->
<div id="adminPanel">
  <h3>Admin Panel</h3>
  <input id="itemName" placeholder="Nombre item"><br>
  <input id="itemImg" placeholder="URL Imagen"><br>
  <input id="itemPrice" type="number" placeholder="Precio"><br>
  <input id="itemValue" type="number" placeholder="Valor"><br>
  <input id="itemStock" type="number" placeholder="Stock"><br>
  <button onclick="addItem()">Agregar Item</button>
  <button onclick="closeAdmin()">Cerrar</button>
  <h4>Items actuales</h4>
  <div id="adminItems"></div>
</div>

<!-- Chat Panel -->
<div id="chatPanel" style="display:none; position:fixed; bottom:20px; right:20px; width:300px; background:#fff; border:1px solid #000; border-radius:10px; padding:10px;">
  <h4 id="chatWith">Chat</h4>
  <div id="chatMessages" style="height:200px; overflow-y:auto; border:1px solid #ccc; margin-bottom:10px; padding:5px;"></div>
  <input id="chatInput" placeholder="Escribe un mensaje..." style="width:80%;">
  <button onclick="sendMessage()">Enviar</button>
  <button onclick="closeChat()">Cerrar</button>
</div>

<script>
  // üîπ Firebase Config
  const firebaseConfig = { 
    apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
    authDomain: "pekora-forum.firebaseapp.com",
    projectId: "pekora-forum",
    storageBucket: "pekora-forum.firebasestorage.app",
    messagingSenderId: "161910967859",
    appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
    measurementId: "G-BPBTW5KBRK"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser = null;
  let currentChatUser = null;
  let unsubscribeChat = null;

  // üîπ Registro
  async function register(){
    const user = document.getElementById("regUser").value;
    const pass = document.getElementById("regPass").value;
    if(!user || !pass) return alert("Completa los campos");

    const snap = await db.collection("users").doc(user).get();
    if(snap.exists) return alert("El usuario ya existe");

    await db.collection("users").doc(user).set({
      username: user,
      password: pass,
      robux: 100,
      friends: [],
      requests: []
    });
    alert("‚úÖ Registrado con √©xito, ahora inicia sesi√≥n");
    showLogin();
  }

  // üîπ Login
  async function login(){
    const user = document.getElementById("loginUser").value;
    const pass = document.getElementById("loginPass").value;
    const snap = await db.collection("users").doc(user).get();
    if(!snap.exists) return alert("Usuario no existe");
    if(snap.data().password !== pass) return alert("Contrase√±a incorrecta");
    currentUser = user;
    localStorage.setItem("currentUser", user);
    startApp();
  }

  function logout(){
    localStorage.removeItem("currentUser");
    location.reload();
  }

  function showRegister(){ document.getElementById("loginArea").style.display="none"; document.getElementById("registerArea").style.display="block"; }
  function showLogin(){ document.getElementById("registerArea").style.display="none"; document.getElementById("loginArea").style.display="block"; }

  async function startApp(){
    document.getElementById("loginArea").style.display="none";
    document.getElementById("registerArea").style.display="none";
    document.getElementById("menu").style.display="block";
    document.getElementById("robuxDisplay").style.display="block";
    updateRobux();
    loadMarketplace();
  }

  async function updateRobux(){
    if(!currentUser) return;
    const snap = await db.collection("users").doc(currentUser).get();
    document.getElementById("robuxAmount").innerText = snap.data().robux;
  }

  // üîπ Marketplace
  async function loadMarketplace(){
    const content = document.getElementById("content");
    content.innerHTML = "<h2>Marketplace</h2><div id='marketItems'></div>";
    const snap = await db.collection("items").get();
    const container = document.getElementById("marketItems");
    snap.forEach(doc=>{
      const item = doc.data();
      const agotado = item.stock <= 0;
      container.innerHTML += `
        <div class="item ${agotado ? 'agotado' : ''}">
          <img src="${item.img}" width="100"><br>
          <b>${item.name}</b><br>
          ‚≠ê ${item.value} - üí∞ ${item.price}<br>
          Stock: ${item.stock}<br>
          ${agotado ? "<b>üö´ Agotado</b>" : `<button class="btn btn-buy" onclick="buyItem('${doc.id}', ${item.price}, ${item.stock})">Comprar</button>`}
        </div>
      `;
    });
  }

  async function buyItem(id, price, stock){
    if(stock <= 0) return alert("‚ùå NO HAY STOCK");

    const userRef = db.collection("users").doc(currentUser);
    const userDoc = await userRef.get();
    let robux = userDoc.data().robux;

    if(robux < price) return alert("No tienes Robux suficientes");

    const itemRef = db.collection("items").doc(id);
    await db.runTransaction(async (t)=>{
      const doc = await t.get(itemRef);
      if(!doc.exists) throw "No existe el item";
      const item = doc.data();
      if(item.stock <= 0) throw "NO HAY STOCK";
      t.update(itemRef, { stock: item.stock - 1 });
      t.update(userRef, { robux: robux - price });
      t.set(userRef.collection("inventory").doc(), item);
    }).then(()=>{
      alert("‚úÖ Comprado!");
      updateRobux();
      loadMarketplace();
    }).catch(err=>{
      alert("‚ùå " + err);
    });
  }

  // üîπ Profile
  async function loadProfile(){
    const content = document.getElementById("content");
    const snap = await db.collection("users").doc(currentUser).get();
    const data = snap.data();

    let html = `<h2>Perfil de ${data.username}</h2>`;
    html += `<p>Robux: üí∞ ${data.robux}</p>`;
    html += `<h3>Inventario:</h3><div id='inventory'></div>`;
    content.innerHTML = html;

    const invSnap = await db.collection("users").doc(currentUser).collection("inventory").get();
    const invDiv = document.getElementById("inventory");
    if(invSnap.empty){ 
      invDiv.innerHTML = "<p>No tienes items.</p>";
    } else {
      invSnap.forEach(doc=>{
        const item = doc.data();
        invDiv.innerHTML += `
          <div class="item">
            <img src="${item.img}" width="80"><br>
            <b>${item.name}</b><br>
            ‚≠ê ${item.value}
          </div>
        `;
      });
    }
  }

  // üîπ Friends
  async function loadFriends(){
    const content = document.getElementById("content");
    content.innerHTML = `
      <h2>Amigos</h2>
      <input id="friendSearch" placeholder="Buscar usuario...">
      <button onclick="searchUser()">Buscar</button>
      <div id="searchResult"></div>
      <h3>Solicitudes</h3>
      <div id="friendRequests"></div>
      <h3>Mis Amigos</h3>
      <div id="myFriends"></div>
    `;
    loadRequests();
    loadMyFriends();
  }

  async function searchUser(){
    const name = document.getElementById("friendSearch").value;
    if(!name) return;
    const snap = await db.collection("users").doc(name).get();
    const result = document.getElementById("searchResult");
    if(!snap.exists){ 
      result.innerHTML = "<p>Usuario no encontrado</p>";
    } else {
      result.innerHTML = `
        <div class="item">
          <b>${name}</b><br>
          <button class="btn btn-friend" onclick="sendRequest('${name}')">Agregar</button>
        </div>
      `;
    }
  }

  async function sendRequest(toUser){
    if(toUser === currentUser) return alert("No puedes agregarte a ti mismo");
    const ref = db.collection("users").doc(toUser);
    const snap = await ref.get();
    if(!snap.exists) return alert("Usuario no existe");

    const data = snap.data();
    if(data.requests.includes(currentUser)) return alert("Ya le enviaste solicitud");

    await ref.update({
      requests: firebase.firestore.FieldValue.arrayUnion(currentUser)
    });
    alert("Solicitud enviada ‚úÖ");
  }

  async function loadRequests(){
    const snap = await db.collection("users").doc(currentUser).get();
    const data = snap.data();
    const cont = document.getElementById("friendRequests");
    cont.innerHTML = "";
    if(!data.requests || data.requests.length === 0){
      cont.innerHTML = "<p>No tienes solicitudes</p>";
      return;
    }
    data.requests.forEach(u=>{
      cont.innerHTML += `
        <div class="item">
          <b>${u}</b><br>
          <button class="btn btn-friend" onclick="acceptRequest('${u}')">Aceptar</button>
        </div>
      `;
    });
  }

  async function acceptRequest(fromUser){
    const meRef = db.collection("users").doc(currentUser);
    const fromRef = db.collection("users").doc(fromUser);

    await meRef.update({
      requests: firebase.firestore.FieldValue.arrayRemove(fromUser),
      friends: firebase.firestore.FieldValue.arrayUnion(fromUser)
    });
    await fromRef.update({
      friends: firebase.firestore.FieldValue.arrayUnion(currentUser)
    });
    loadRequests();
    loadMyFriends();
  }

  async function loadMyFriends(){
    const snap = await db.collection("users").doc(currentUser).get();
    const data = snap.data();
    const cont = document.getElementById("myFriends");
    cont.innerHTML = "";
    if(!data.friends || data.friends.length === 0){
      cont.innerHTML = "<p>No tienes amigos</p>";
      return;
    }
    for(const u of data.friends){
      const chatId = getChatId(currentUser, u);
      const unreadSnap = await db.collection("chats")
        .doc(chatId)
        .collection("messages")
        .where("to", "==", currentUser)
        .where("read", "==", false)
        .get();
      const unreadCount = unreadSnap.size;
      cont.innerHTML += `
        <div class="item">
          <b>${u}</b><br>
          <button class="btn btn-friend" onclick="openChat('${u}')">
            Chatear ${unreadCount > 0 ? "üì©("+unreadCount+")" : ""}
          </button>
        </div>
      `;
    }
  }

  // üîπ Chat
  function getChatId(u1, u2){
    return [u1, u2].sort().join("_");
  }

  async function openChat(friend){
    currentChatUser = friend;
    document.getElementById("chatWith").innerText = "Chat con " + friend;
    document.getElementById("chatPanel").style.display = "block";
    loadChat(friend);

    // üîπ marcar como le√≠dos
    const chatId = getChatId(currentUser, friend);
    const unread = await db.collection("chats").doc(chatId).collection("messages")
      .where("to", "==", currentUser)
      .where("read", "==", false).get();
    unread.forEach(async doc=>{
      await doc.ref.update({ read:true });
    });
    loadMyFriends();
  }

  function closeChat(){
    document.getElementById("chatPanel").style.display = "none";
    if(unsubscribeChat) unsubscribeChat();
    currentChatUser = null;
  }

  function loadChat(friend){
    const chatId = getChatId(currentUser, friend);
    const chatRef = db.collection("chats").doc(chatId).collection("messages").orderBy("time");

    if(unsubscribeChat) unsubscribeChat();

    unsubscribeChat = chatRef.onSnapshot(snap=>{
      const div = document.getElementById("chatMessages");
      div.innerHTML = "";
      snap.forEach(doc=>{
        const msg = doc.data();
        div.innerHTML += `<p><b>${msg.from}:</b> ${msg.text}</p>`;
      });
      div.scrollTop = div.scrollHeight;
    });
  }

  async function sendMessage(){
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if(!text) return;

    const chatId = getChatId(currentUser, currentChatUser);
    await db.collection("chats").doc(chatId).collection("messages").add({
      from: currentUser,
      to: currentChatUser,
      text,
      read:false,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });

    input.value = "";
  }

  // üîπ Admin
  async function addItem(){
    const name = document.getElementById("itemName").value;
    const img = document.getElementById("itemImg").value;
    const price = parseInt(document.getElementById("itemPrice").value);
    const value = parseInt(document.getElementById("itemValue").value);
    const stock = parseInt(document.getElementById("itemStock").value);

    if(!name || !img || !price || !stock) return alert("Completa todos los campos");

    await db.collection("items").add({ name, img, price, value, stock });
    loadAdminItems();
    alert("‚úÖ Item agregado");
  }

  async function loadAdminItems(){
    const container = document.getElementById("adminItems");
    container.innerHTML = "";
    const snap = await db.collection("items").get();
    if(snap.empty){
      container.innerHTML = "<p>No hay items</p>";
      return;
    }
    snap.forEach(doc=>{
      const item = doc.data();
      container.innerHTML += `
        <div class="item">
          <b>${item.name}</b><br>
          Stock: ${item.stock}<br>
          <button class="btn btn-edit" onclick="updateStock('${doc.id}')">Editar Stock</button>
        </div>
      `;
    });
  }

  async function updateStock(id){
    const nuevo = prompt("Nuevo stock:");
    if(!nuevo) return;
    await db.collection("items").doc(id).update({ stock: parseInt(nuevo) });
    loadAdminItems();
  }

  function closeAdmin(){ document.getElementById("adminPanel").style.display="none"; }

  // üîπ Auto login
  window.onload = ()=>{
    const saved = localStorage.getItem("currentUser");
    if(saved){
      currentUser = saved;
      startApp();
    }
  }
</script>
</body>
</html>
