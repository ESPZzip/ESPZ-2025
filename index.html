<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Roblox Revival</title>

  <!-- SDKs COMPAT (necesarios si usas firebase.* en vez del API modular) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1222; --panel:#171a2e; --panel2:#1f2340; --accent:#4cc9f0; --accent2:#3aa6cf; --text:#e9eef5;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--text); background:linear-gradient(180deg,#0b0e1b, #0f1222 40%, #0f1222); }
    header{ display:flex; align-items:center; justify-content:space-between; padding:12px 18px; background:var(--panel); border-bottom:1px solid #2b2f52; position:sticky; top:0; z-index:5; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; }
    .brand .dot{ width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 12px var(--accent); }
    .rightbox{ display:flex; align-items:center; gap:12px; }
    .badge{ display:none; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; background:var(--panel2); border:1px solid #2b2f52; font-weight:600; }
    .userTag{ display:none; padding:6px 10px; border-radius:10px; background:#223; border:1px solid #2b2f52; }
    .btn{ cursor:pointer; border:none; border-radius:10px; padding:8px 12px; font-weight:600; background:var(--accent); color:#03111a; box-shadow:0 6px 18px rgba(76,201,240,.25); }
    .btn:hover{ background:var(--accent2); }
    #logoutBtn{ display:none; background:#ff5d6c; color:white; box-shadow:none; }
    #logoutBtn:hover{ filter:brightness(1.05) }

    .app{ display:none; min-height:calc(100vh - 60px); }
    .shell{ display:flex; }
    .sidebar{ width:230px; background:var(--panel); border-right:1px solid #2b2f52; padding:14px; display:flex; flex-direction:column; gap:10px; position:sticky; top:60px; height:calc(100vh - 60px); }
    .navbtn{ width:100%; text-align:left; background:#232648; color:#dfe7ff; border:1px solid #2b2f52; padding:12px; border-radius:12px; cursor:pointer; font-weight:600; }
    .navbtn:hover{ background:#2a2e57; }
    .content{ flex:1; padding:22px; }
    h2{ margin:6px 0 12px 0 }

    /* Auth card */
    .authWrap{ display:flex; align-items:center; justify-content:center; padding:40px 16px; }
    .card{ width:100%; max-width:380px; background:var(--panel); border:1px solid #2b2f52; border-radius:16px; padding:22px; box-shadow:0 10px 40px rgba(0,0,0,.35); }
    .input{ width:100%; padding:10px 12px; margin-top:8px; border-radius:10px; border:1px solid #2b2f52; background:#0f1330; color:var(--text); outline:none; }
    .split{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
    .muted{ color:#a3acc6; font-size:.9rem; }

    /* Marketplace & items */
    #market{ display:grid; grid-template-columns:repeat(auto-fill, minmax(170px,1fr)); gap:14px; }
    .item{ background:var(--panel2); border:1px solid #2b2f52; padding:12px; border-radius:14px; text-align:center; }
    .item img{ width:120px; height:120px; object-fit:cover; border-radius:12px; background:#0e1022; border:1px solid #2b2f52; }
    .item b{ display:block; margin:8px 0 4px; }
    .item .meta{ font-size:.9rem; opacity:.9; }
    .row{ display:flex; gap:8px; justify-content:center; margin-top:10px; }

    /* Admin panel modal */
    #adminPanel{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center; z-index:50; }
    #adminCard{ width:100%; max-width:480px; background:var(--panel); border:1px solid #2b2f52; border-radius:16px; padding:18px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .closeX{ float:right; background:#333a; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }

    /* Profile inventory */
    #inv{ display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:12px; }
    .empty{ opacity:.8; padding:10px 0; }

    /* Small helper */
    .hidden{ display:none !important; }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div class="dot"></div>
      <div>Roblox Revival</div>
    </div>
    <div class="rightbox">
      <div id="userTag" class="userTag">üë§ <span id="userNameTag"></span></div>
      <div id="robuxBox" class="badge">üí∞ <span id="robuxDisplay">0</span> R$</div>
      <button id="logoutBtn" class="btn" onclick="logout()">Salir</button>
    </div>
  </header>

  <!-- Auth -->
  <section id="authSection" class="authWrap">
    <div class="card">
      <h2>Crear cuenta</h2>
      <input class="input" id="regUsername" placeholder="Usuario (solo letras/n√∫meros/_)" />
      <input class="input" id="regPassword" type="password" placeholder="Contrase√±a" />
      <div class="split">
        <button class="btn" onclick="register()">Registrar</button>
        <button class="navbtn" onclick="quickFill()">Auto-prueba</button>
      </div>
      <hr style="border-color:#2b2f52; margin:18px 0">
      <h2>Iniciar sesi√≥n</h2>
      <input class="input" id="logUsername" placeholder="Usuario" />
      <input class="input" id="logPassword" type="password" placeholder="Contrase√±a" />
      <button style="margin-top:14px" class="btn" onclick="login()">Entrar</button>
      <p class="muted" style="margin-top:8px">Tip: usuario <b>admin</b> podr√° borrar √≠tems.</p>
    </div>
  </section>

  <!-- App -->
  <section id="mainSection" class="app">
    <div class="shell">
      <aside class="sidebar">
        <button class="navbtn" onclick="showSection('marketplace')">üõí Marketplace</button>
        <button class="navbtn" onclick="showSection('profile')">üë§ Profile</button>
        <button class="navbtn" onclick="showSection('friends')">üë• Friends</button>
      </aside>
      <main class="content">
        <h2>Bienvenido</h2>
        <p class="muted">Elige una secci√≥n del men√∫ izquierdo.</p>
      </main>
    </div>
  </section>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <div id="adminCard">
      <button class="closeX" onclick="closeAdmin()">Cerrar ‚úñ</button>
      <h2>Admin Panel</h2>
      <div class="grid2">
        <input class="input" id="itemName" placeholder="Nombre del √≠tem" />
        <input class="input" id="itemImg" placeholder="URL de imagen" />
        <input class="input" id="itemPrice" type="number" placeholder="Precio (R$)" />
        <input class="input" id="itemValue" type="number" placeholder="Valor" />
      </div>
      <div style="margin-top:12px; display:flex; gap:10px">
        <button class="btn" onclick="addItem()">Agregar √çtem</button>
        <button class="navbtn" onclick="closeAdmin()">Cerrar</button>
      </div>
    </div>
  </div>

<script>
/* =====================  FIREBASE  ===================== */
const firebaseConfig = { 
  apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
  authDomain: "pekora-forum.firebaseapp.com",
  projectId: "pekora-forum",
  storageBucket: "pekora-forum.firebasestorage.app",
  messagingSenderId: "161910967859",
  appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
  measurementId: "G-BPBTW5KBRK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =====================  STATE  ===================== */
let currentUser = null;
let marketUnsub = null; // para evitar m√∫ltiples listeners

/* =====================  HELPERS  ===================== */
function validUsername(u){
  return /^[A-Za-z0-9_]{3,20}$/.test(u);
}

async function sha256(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

function uiLoggedIn(username, robux){
  // Header
  document.getElementById("userNameTag").textContent = username;
  document.getElementById("userTag").style.display = "inline-flex";
  document.getElementById("robuxDisplay").textContent = robux ?? 0;
  document.getElementById("robuxBox").style.display = "inline-flex";
  document.getElementById("logoutBtn").style.display = "inline-block";
  // Views
  document.querySelector("main.content").innerHTML = `<h2>Marketplace</h2><div id="market">Cargando...</div>`;
  document.getElementById("authSection").style.display = "none";
  document.getElementById("mainSection").style.display = "block";
}

function uiLoggedOut(){
  document.getElementById("authSection").style.display = "flex";
  document.getElementById("mainSection").style.display = "none";
  document.getElementById("userTag").style.display = "none";
  document.getElementById("robuxBox").style.display = "none";
  document.getElementById("logoutBtn").style.display = "none";
}

/* =====================  AUTH (Firestore, sin Auth)  ===================== */
// Registro con hash de contrase√±a (mejor que plano)
async function register(){
  try{
    const user = document.getElementById("regUsername").value.trim();
    const pass = document.getElementById("regPassword").value;

    if(!user || !pass) return alert("Completa usuario y contrase√±a");
    if(!validUsername(user)) return alert("Usuario inv√°lido. Usa 3-20 chars [A-Z,a-z,0-9,_]");

    const docRef = db.collection("users").doc(user);
    const exists = await docRef.get();
    if(exists.exists) return alert("Ese usuario ya existe, elige otro");

    const passwordHash = await sha256(pass);
    await docRef.set({ username:user, passwordHash, robux:500, createdAt: firebase.firestore.FieldValue.serverTimestamp() });

    // auto-login
    currentUser = user;
    localStorage.setItem("loggedUser", user);
    await loadUserData();
    showSection('marketplace');
    alert("¬°Cuenta creada! Bienvenido, " + user);
  }catch(err){
    console.error("Register error:", err);
    alert("Error al registrar: " + (err.message || err));
  }
}

async function login(){
  try{
    const user = document.getElementById("logUsername").value.trim();
    const pass = document.getElementById("logPassword").value;

    if(!user || !pass) return alert("Completa usuario y contrase√±a");

    const docRef = db.collection("users").doc(user);
    const snap = await docRef.get();
    if(!snap.exists) return alert("Usuario no encontrado");

    const passwordHash = await sha256(pass);
    if(snap.data().passwordHash !== passwordHash) return alert("Contrase√±a incorrecta");

    currentUser = user;
    localStorage.setItem("loggedUser", user);
    await loadUserData();
    showSection('marketplace');
    alert("¬°Bienvenido de nuevo, " + user + "!");
  }catch(err){
    console.error("Login error:", err);
    alert("Error al iniciar sesi√≥n: " + (err.message || err));
  }
}

function logout(){
  currentUser = null;
  localStorage.removeItem("loggedUser");
  // Cerrar listener de marketplace si estuviera activo
  if(typeof marketUnsub === "function"){ marketUnsub(); marketUnsub = null; }
  uiLoggedOut();
}

/* Mantener sesi√≥n */
window.addEventListener("load", async () => {
  const saved = localStorage.getItem("loggedUser");
  if(saved){
    currentUser = saved;
    try{
      await loadUserData();
      showSection('marketplace');
    }catch(e){
      console.warn("No se pudo restaurar sesi√≥n:", e);
      logout();
    }
  }else{
    uiLoggedOut();
  }
});

/* =====================  DATA LOADERS  ===================== */
async function loadUserData(){
  if(!currentUser) return;
  const snap = await db.collection("users").doc(currentUser).get();
  if(!snap.exists) throw new Error("Usuario no existe");
  const { robux=0 } = snap.data();
  uiLoggedIn(currentUser, robux);
}

/* =====================  NAV / SECCIONES  ===================== */
function showSection(section){
  if(section==="marketplace") loadMarketplace();
  else if(section==="profile") loadProfile();
  else if(section==="friends") loadFriends();
}

/* ---------- MARKETPLACE ---------- */
function loadMarketplace(){
  const main = document.querySelector("main.content");
  main.innerHTML = `<h2>Marketplace</h2><div id="market" class="muted">Cargando...</div>`;

  // Evita listeners duplicados al navegar
  if(typeof marketUnsub === "function"){ marketUnsub(); marketUnsub = null; }

  marketUnsub = db.collection("items").orderBy("price","asc").onSnapshot(snap=>{
    const market = document.getElementById("market");
    if(snap.empty){ market.innerHTML = `<p class="empty">No hay √≠tems a√∫n.</p>`; return; }
    let html = "";
    snap.forEach(doc=>{
      const d = doc.data();
      html += `
        <div class="item">
          <img src="${d.img || ''}" alt="${d.name || ''}">
          <b>${d.name || 'Sin nombre'}</b>
          <div class="meta">üí∞ ${d.price ?? 0} R$ ‚Ä¢ Valor ${d.value ?? 0}</div>
          <div class="row">
            <button class="btn" onclick="buyItem('${doc.id}', ${Number(d.price)||0})">Comprar</button>
            ${currentUser==='admin' ? `<button class="navbtn" onclick="deleteItem('${doc.id}')">Eliminar</button>` : ``}
          </div>
        </div>`;
    });
    market.innerHTML = html;
  }, err=>{
    console.error("onSnapshot items:", err);
    document.getElementById("market").innerHTML = `<p class="empty">Error cargando Marketplace.</p>`;
  });
}

/* Comprar item: resta robux y guarda copia en inventario */
async function buyItem(itemId, price){
  try{
    const uref = db.collection("users").doc(currentUser);
    const usnap = await uref.get();
    const robux = Number(usnap.data().robux||0);
    if(robux < Number(price)) return alert("No tienes suficientes Robux.");

    // Traigo el √≠tem
    const isnap = await db.collection("items").doc(itemId).get();
    if(!isnap.exists) return alert("El √≠tem ya no existe.");
    const it = isnap.data();

    // Actualizo Robux y agrego inventario (mejor en una transacci√≥n simple)
    await db.runTransaction(async (tx)=>{
      const udoc = await tx.get(uref);
      const curr = Number(udoc.data().robux||0);
      if(curr < Number(price)) throw new Error("Saldo insuficiente");
      tx.update(uref, { robux: curr - Number(price) });
      const invRef = uref.collection("inventory").doc();
      tx.set(invRef, {
        itemId,
        name: it.name,
        img: it.img,
        price: Number(it.price)||0,
        value: Number(it.value)||0,
        boughtAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    // refresco la UI del header
    const refreshed = await db.collection("users").doc(currentUser).get();
    document.getElementById("robuxDisplay").textContent = Number(refreshed.data().robux||0);
    alert("¬°Compra realizada!");
  }catch(err){
    console.error("buyItem:", err);
    alert("No se pudo completar la compra: " + (err.message||err));
  }
}

/* Eliminar √≠tem (solo admin) */
async function deleteItem(id){
  try{
    if(currentUser !== 'admin') return alert("Solo el usuario 'admin' puede eliminar √≠tems.");
    await db.collection("items").doc(id).delete();
  }catch(err){
    console.error("deleteItem:", err);
    alert("No se pudo eliminar: " + (err.message||err));
  }
}

/* ---------- PROFILE ---------- */
async function loadProfile(){
  const main = document.querySelector("main.content");
  main.innerHTML = `<h2>Perfil</h2><div class="muted">Cargando...</div>`;
  const uref = db.collection("users").doc(currentUser);
  const usnap = await uref.get();
  const robux = Number(usnap.data().robux||0);

  const invSnap = await uref.collection("inventory").orderBy("boughtAt","desc").get();
  let invHTML = "";
  invSnap.forEach(d=>{
    const it = d.data();
    invHTML += `
      <div class="item">
        <img src="${it.img||''}" alt="${it.name||''}">
        <b>${it.name||'Item'}</b>
        <div class="meta">üí∞ ${Number(it.price)||0} R$ ‚Ä¢ Valor ${Number(it.value)||0}</div>
      </div>`;
  });

  main.innerHTML = `
    <h2>Perfil de ${currentUser}</h2>
    <p class="muted">Robux actuales: <b>${robux}</b></p>
    <h3>Inventario</h3>
    <div id="inv">${invHTML || `<p class="empty">Inventario vac√≠o</p>`}</div>
  `;
}

/* ---------- FRIENDS (placeholder) ---------- */
function loadFriends(){
  const main = document.querySelector("main.content");
  main.innerHTML = `
    <h2>Friends</h2>
    <p class="muted">Pr√≥ximamente: buscador, solicitudes y lista de amigos compartida por Firestore.</p>
  `;
}

/* ---------- ADMIN PANEL ---------- */
document.addEventListener("keydown", (e)=>{
  if(e.key === "Insert"){
    const pass = prompt("Contrase√±a admin:");
    if(pass === "crackythebest"){
      document.getElementById("adminPanel").style.display = "flex";
    }
  }
});
function closeAdmin(){ document.getElementById("adminPanel").style.display = "none"; }
async function addItem(){
  try{
    const name = document.getElementById("itemName").value.trim();
    const img  = document.getElementById("itemImg").value.trim();
    const price= Number(document.getElementById("itemPrice").value);
    const value= Number(document.getElementById("itemValue").value);
    if(!name || !img || !price || !value) return alert("Completa todos los campos del √≠tem");
    await db.collection("items").add({ name, img, price, value, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    alert("√çtem agregado");
    // limpiar campos
    document.getElementById("itemName").value="";
    document.getElementById("itemImg").value="";
    document.getElementById("itemPrice").value="";
    document.getElementById("itemValue").value="";
  }catch(err){
    console.error("addItem:", err);
    alert("Error al agregar √≠tem: " + (err.message||err));
  }
}

/* ---------- UTIL: autofill para probar r√°pido ---------- */
function quickFill(){
  const rnd = Math.floor(Math.random()*1000);
  document.getElementById("regUsername").value = "user_"+rnd;
  document.getElementById("regPassword").value = "123456";
}
</script>
</body>
</html>
