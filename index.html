<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ESP:Z - Home</title>
  <style>
    body { font-family: Arial; background:#eee; margin:0; }
    header { background:#444; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    #robuxDisplay { font-weight:bold; }
    #main { display:flex; }
    nav { width:150px; background:#ddd; padding:10px; display:flex; flex-direction:column; gap:10px; }
    nav button { padding:8px; cursor:pointer; }
    #content { flex:1; padding:20px; }
    .item { border:1px solid #aaa; padding:10px; margin:10px; border-radius:5px; background:white; display:inline-block; text-align:center; }
    #adminPanel { display:none; position:fixed; top:50px; left:50px; background:white; border:2px solid black; padding:20px; z-index:999; }
    #giveawayPanel { display:none; position:fixed; top:100px; left:100px; background:white; border:2px solid #444; padding:20px; z-index:998; }
    .agotado { opacity:0.5; }
    .tag { padding:2px 6px; border-radius:6px; font-size:12px; font-weight:bold; display:inline-block; margin-bottom:4px; }
  </style>
</head>
<body>
<header>
  <div id="userDisplay">No logueado</div>
  <div id="robuxDisplay" style="display:none;">üí∞ <span id="robuxCount">0</span></div>
</header>

<div id="auth">
  <h2>Login / Registro</h2>
  <input id="username" placeholder="Usuario"><br>
  <input id="password" type="password" placeholder="Contrase√±a"><br>
  <button onclick="register()">Registrar</button>
  <button onclick="login()">Login</button>
</div>

<div id="main" style="display:none;">
  <nav>
    <button onclick="loadMarket()">Marketplace</button>
    <button onclick="loadProfile()">Profile</button>
    <button onclick="loadFriends()">Friends</button>
    <!-- üîπ Bot√≥n Giveaways (solo ROBLOX) -->
    <button id="giveawaysBtn" style="display:none;" onclick="openGiveaways()">Giveaways</button>
    <!-- üîπ Bot√≥n Cerrar Sesi√≥n -->
    <button id="logoutBtn" style="display:none;" onclick="logout()">Cerrar Sesi√≥n</button>
  </nav>
  <div id="content"></div>
</div>

<!-- üîπ Admin Panel -->
<div id="adminPanel">
  <h2>Admin Panel</h2>
  <h3>‚ûï Agregar Item</h3>
  <input id="itemName" placeholder="Nombre item"><br>
  <input id="itemImg" placeholder="URL imagen"><br>
  <input id="itemPrice" placeholder="Precio"><br>
  <input id="itemValue" placeholder="Valor"><br>
  <input id="itemStock" placeholder="Stock"><br>
  <input id="itemTagText" placeholder="Tag texto (opcional)"><br>
  <input id="itemTagColor" placeholder="Color tag"><br>
  <input id="itemTagBg" placeholder="Fondo tag"><br>
  <button onclick="addItem()">Agregar Item</button>
  <div id="adminItems"></div>
  <br>
  <button onclick="closeAdmin()">Cerrar</button>
</div>

<!-- üîπ Giveaway Panel -->
<div id="giveawayPanel">
  <h2>üéÅ Giveaways</h2>
  <input id="giveUser" placeholder="Usuario destino"><br>
  <input id="giveAmount" type="number" placeholder="Cantidad Robux"><br>
  <button onclick="sendGiveaway()">Enviar</button>
  <button onclick="closeGiveaways()">Cerrar</button>
</div>

<!-- üîπ Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = { 
    apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
    authDomain: "pekora-forum.firebaseapp.com",
    projectId: "pekora-forum",
    storageBucket: "pekora-forum.firebasestorage.app",
    messagingSenderId: "161910967859",
    appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
    measurementId: "G-BPBTW5KBRK"
  };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore();

  let currentUser=null;
  let robuxInterval=null;

  // üîπ Registro
  async function register(){
    const u=document.getElementById("username").value;
    const p=document.getElementById("password").value;
    if(!u||!p) return alert("Completa todos los campos");
    const ref=db.collection("users").doc(u);
    const doc=await ref.get();
    if(doc.exists) return alert("Usuario ya existe");
    await ref.set({username:u,password:p,robux:100,friends:[],requests:[]});
    alert("Registrado!");
    localStorage.setItem("currentUser",u);
    currentUser=u; startApp();
  }

  // üîπ Login
  async function login(){
    const u=document.getElementById("username").value;
    const p=document.getElementById("password").value;
    const ref=db.collection("users").doc(u);
    const doc=await ref.get();
    if(!doc.exists) return alert("No existe");
    if(doc.data().password!==p) return alert("Contrase√±a incorrecta");
    localStorage.setItem("currentUser",u);
    currentUser=u; startApp();
  }

  function startApp(){
    document.getElementById("auth").style.display="none";
    document.getElementById("main").style.display="flex";
    const userDisplay=currentUser==="ROBLOX" 
      ? `${currentUser} <span style="color:red;font-weight:bold;">[ADMIN]</span>` 
      : currentUser;
    document.getElementById("userDisplay").innerHTML=userDisplay;
    document.getElementById("robuxDisplay").style.display="block";
    document.getElementById("logoutBtn").style.display="block";
    if(currentUser==="ROBLOX"){ 
      document.getElementById("giveawaysBtn").style.display="block"; 
    }
    loadMarket();
    updateRobux();
    startRobuxBonus();
  }

  async function updateRobux(){
    const snap=await db.collection("users").doc(currentUser).get();
    if(snap.exists){
      document.getElementById("robuxCount").innerText=snap.data().robux;
    }
  }

  // üîπ Bonus de Robux cada minuto
  function startRobuxBonus(){
    if(robuxInterval) clearInterval(robuxInterval);
    robuxInterval=setInterval(async ()=>{
      const ref=db.collection("users").doc(currentUser);
      const snap=await ref.get();
      if(snap.exists){
        const newRobux=snap.data().robux+20;
        await ref.update({robux:newRobux});
        document.getElementById("robuxCount").innerText=newRobux;
      }
    },60000);
  }

  // üîπ Logout
  function logout(){
    localStorage.removeItem("currentUser");
    location.reload();
  }

  // üîπ Giveaways
  function openGiveaways(){ document.getElementById("giveawayPanel").style.display="block"; }
  function closeGiveaways(){ document.getElementById("giveawayPanel").style.display="none"; }

  async function sendGiveaway(){
    const user=document.getElementById("giveUser").value;
    const amount=parseInt(document.getElementById("giveAmount").value);
    if(!user||!amount) return alert("Completa los campos");
    const ref=db.collection("users").doc(user);
    const snap=await ref.get();
    if(!snap.exists) return alert("Usuario no existe");
    const newRobux=snap.data().robux+amount;
    await ref.update({robux:newRobux});
    alert(`Le diste ${amount} Robux a ${user}`);
    closeGiveaways();
  }

  // üîπ Marketplace
  async function loadMarket(){
    const snap=await db.collection("items").get();
    const cont=document.getElementById("content");
    cont.innerHTML="<h2>Marketplace</h2>";
    snap.forEach(doc=>{
      const item=doc.data();
      cont.innerHTML+=`
        <div class="item ${item.stock===0?'agotado':''}">
          ${item.tag?`<div class="tag" style="color:${item.tag.color};background:${item.tag.bg};">${item.tag.text}</div>`:""}
          <img src="${item.img}" width="80"><br>
          <b>${item.name}</b><br>
          üí∞ ${item.price} | ‚≠ê ${item.value}<br>
          Stock: ${item.stock}<br>
          <button onclick="buyItem('${doc.id}')">Comprar</button>
        </div>`;
    });
  }

  async function buyItem(id){
    const ref=db.collection("items").doc(id);
    const snap=await ref.get();
    if(!snap.exists) return;
    const item=snap.data();
    if(item.stock<=0){alert("NO HAY STOCK"); return;}
    const userRef=db.collection("users").doc(currentUser);
    const uData=(await userRef.get()).data();
    if(uData.robux<item.price){alert("No tienes Robux"); return;}
    await userRef.update({robux:uData.robux-item.price});
    await userRef.collection("inventory").doc(item.name).set(item);
    await ref.update({stock:item.stock-1});
    alert("Comprado!");
    updateRobux(); loadMarket();
  }

  // üîπ Profile
  async function loadProfile(){
    const cont=document.getElementById("content");
    cont.innerHTML="<h2>Perfil</h2><div id='inv'></div>";
    const invSnap=await db.collection("users").doc(currentUser).collection("inventory").get();
    const invDiv=document.getElementById("inv");
    if(invSnap.empty) invDiv.innerHTML="<p>Sin items</p>";
    else invSnap.forEach(doc=>{
      const item=doc.data();
      invDiv.innerHTML+=`
        <div class="item">
          ${item.tag?`<div class="tag" style="color:${item.tag.color};background:${item.tag.bg};">${item.tag.text}</div>`:""}
          <img src="${item.img}" width="80"><br>
          <b>${item.name}</b><br>
          ‚≠ê ${item.value}
        </div>`;
    });
  }

  // üîπ Friends
  async function loadFriends(){
    const cont=document.getElementById("content");
    cont.innerHTML=`<h2>Friends</h2>
      <input id="friendSearch" placeholder="Buscar usuario">
      <button onclick="searchFriend()">Buscar</button>
      <div id="friendResult"></div>
      <hr><h3>Solicitudes</h3><div id="reqs"></div>
      <hr><h3>Tus Amigos</h3><div id="myfriends"></div>`;
    showRequests(); showFriends();
  }

  async function searchFriend(){
    const name=document.getElementById("friendSearch").value;
    if(!name) return;
    if(name===currentUser) return alert("No puedes agregarte a ti mismo");
    const ref=db.collection("users").doc(name);
    const snap=await ref.get();
    if(!snap.exists){document.getElementById("friendResult").innerHTML="Usuario no encontrado"; return;}
    document.getElementById("friendResult").innerHTML=
      `${name} <button onclick="sendRequest('${name}')">Enviar solicitud</button>`;
  }

  async function sendRequest(to){
    const ref=db.collection("users").doc(to);
    await ref.update({
      requests:firebase.firestore.FieldValue.arrayUnion(currentUser)
    });
    alert("Solicitud enviada");
  }

  async function showRequests(){
    const ref=db.collection("users").doc(currentUser);
    const snap=await ref.get();
    const reqs=snap.data().requests||[];
    const cont=document.getElementById("reqs");
    cont.innerHTML="";
    reqs.forEach(r=>{
      cont.innerHTML+=`${r} <button onclick="acceptRequest('${r}')">Aceptar</button><br>`;
    });
  }

  async function acceptRequest(from){
    const userRef=db.collection("users").doc(currentUser);
    const otherRef=db.collection("users").doc(from);
    await userRef.update({
      requests:firebase.firestore.FieldValue.arrayRemove(from),
      friends:firebase.firestore.FieldValue.arrayUnion(from)
    });
    await otherRef.update({
      friends:firebase.firestore.FieldValue.arrayUnion(currentUser)
    });
    loadFriends();
  }

  async function showFriends(){
    const ref=db.collection("users").doc(currentUser);
    const snap=await ref.get();
    const friends=snap.data().friends||[];
    const cont=document.getElementById("myfriends");
    cont.innerHTML="";
    friends.forEach(f=>{
      cont.innerHTML+=`${f}<br>`;
    });
  }

  // üîπ Admin Panel
  async function addItem(){
    const name=document.getElementById("itemName").value;
    const img=document.getElementById("itemImg").value;
    const price=parseInt(document.getElementById("itemPrice").value);
    const value=parseInt(document.getElementById("itemValue").value);
    const stock=parseInt(document.getElementById("itemStock").value);
    const tagText=document.getElementById("itemTagText").value;
    const tagColor=document.getElementById("itemTagColor").value;
    const tagBg=document.getElementById("itemTagBg").value;
    const tag=tagText?{text:tagText,color:tagColor||"black",bg:tagBg||"yellow"}:null;
    await db.collection("items").doc(name).set({name,img,price,value,stock,tag});
    alert("Item agregado");
    loadAdmin();
  }

  async function loadAdmin(){
    const panel=document.getElementById("adminPanel");
    panel.style.display="block";
    const cont=document.getElementById("adminItems");
    cont.innerHTML="<h3>Items actuales:</h3>";
    const snap=await db.collection("items").get();
    snap.forEach(doc=>{
      const item=doc.data();
      cont.innerHTML+=`
        <div class="item">
          ${item.tag?`<div class="tag" style="color:${item.tag.color};background:${item.tag.bg};">${item.tag.text}</div>`:""}
          <img src="${item.img}" width="60"> <b>${item.name}</b> 
          üí∞${item.price} | ‚≠ê${item.value} | Stock: ${item.stock}
          <button onclick="deleteItem('${doc.id}')">‚ùå Eliminar</button>
        </div>`;
    });
  }

  async function deleteItem(id){
    if(confirm("¬øSeguro que quieres eliminar este item?")){
      await db.collection("items").doc(id).delete();
      alert("Item eliminado del Marketplace");
      loadAdmin();
      loadMarket();
    }
  }

  function closeAdmin(){ document.getElementById("adminPanel").style.display="none"; }

  // üîπ Tecla INSERT solo para ROBLOX
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Insert" && currentUser==="ROBLOX"){
      const panel=document.getElementById("adminPanel");
      if(panel.style.display==="block"){closeAdmin();} else {loadAdmin();}
    }
  });

  // üîπ Mantener login
  window.onload=function(){
    const u=localStorage.getItem("currentUser");
    if(u){currentUser=u;startApp();}
  }
</script>
</body>
</html>
