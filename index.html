<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Roblox Revival - Firestore Only</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#1e1e2f; color:white; margin:0; padding:0; }
    header { background:#2c2c40; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    .layout { display:flex; height:90vh; }
    .sidebar { width:200px; background:#2c2c40; padding:20px 10px; display:flex; flex-direction:column; gap:10px; }
    .sidebar button { background:#4cc9f0; border:none; padding:12px; border-radius:8px; cursor:pointer; text-align:left; }
    .sidebar button:hover { background:#3a9bdc; }
    .content { flex:1; padding:20px; overflow-y:auto; }
    .item { background:#3a3a55; padding:10px; border-radius:10px; margin:10px; text-align:center; display:inline-block; width:150px; }
    .item img { width:100px; height:100px; object-fit:cover; border-radius:8px; }
    .delete-btn { background:#ff4d4d; margin-top:8px; }
    #adminPanel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#111; padding:20px; border:2px solid white; border-radius:10px; }
    .card { background:#2c2c40; padding:20px; border-radius:12px; width:300px; margin:auto; margin-top:100px; text-align:center; }
    input { display:block; margin:10px auto; padding:10px; width:80%; border:none; border-radius:6px; }
    button { background:#3a86ff; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; margin-top:10px; }
    button:hover { background:#265dcc; }
  </style>
</head>
<body>

  <!-- Pantalla de login/register -->
  <div id="auth" class="card">
    <h2>Registro / Login</h2>
    <input type="text" id="username" placeholder="Nombre de usuario">
    <input type="password" id="password" placeholder="Contrase√±a">
    <button onclick="register()">Registrarse</button>
    <button onclick="login()">Iniciar Sesi√≥n</button>
    <p id="authMsg"></p>
  </div>

  <!-- Layout principal -->
  <div id="app" style="display:none; flex-direction:column; height:100vh;">
    <header>
      <h2>Bienvenido <span id="displayUser"></span></h2>
      <div class="robux">üí∞ <span id="robuxCount">100</span></div>
    </header>
    <div class="layout">
      <div class="sidebar">
        <button onclick="showPage('marketplace')">Marketplace</button>
        <button onclick="showPage('profile')">Profile</button>
        <button onclick="showPage('friends')">Friends</button>
      </div>
      <div class="content" id="contentArea">
        <h2>Selecciona una opci√≥n del men√∫</h2>
      </div>
    </div>
  </div>

  <!-- Panel Admin -->
  <div id="adminPanel">
    <h2>Panel Admin</h2>
    <p>Agregar √≠tem al Marketplace:</p>
    <input type="text" id="itemName" placeholder="Nombre del √≠tem">
    <input type="text" id="itemImg" placeholder="URL de imagen">
    <input type="number" id="itemPrice" placeholder="Precio">
    <input type="number" id="itemValue" placeholder="Valor">
    <button onclick="addItem()">Agregar √çtem</button>
    <button onclick="closeAdmin()">Cerrar</button>
  </div>

  <script>
    // üöÄ Configura tu Firebase aqu√≠
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROJECT.firebaseapp.com",
      projectId: "TU_PROJECT",
      storageBucket: "TU_PROJECT.appspot.com",
      messagingSenderId: "ID",
      appId: "APP_ID"
    };
    const appFB = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;

    // Guardar sesi√≥n si existe
    window.onload = async () => {
      const savedUser = localStorage.getItem("revivalUser");
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
      }
    };

    async function register() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      if (!username || !password) {
        document.getElementById("authMsg").innerText = "Completa todos los campos.";
        return;
      }
      // Ver si ya existe
      const snap = await db.collection("users").where("username", "==", username).get();
      if (!snap.empty) {
        document.getElementById("authMsg").innerText = "Ese nombre ya est√° en uso.";
        return;
      }
      // Crear user
      await db.collection("users").add({
        username,
        password, // ‚ö†Ô∏è aqu√≠ conviene encriptar con hash (ejemplo: SHA-256)
        friends: [],
        requests: []
      });
      document.getElementById("authMsg").innerText = "Registro exitoso, ahora inicia sesi√≥n.";
    }

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const snap = await db.collection("users")
        .where("username", "==", username)
        .where("password", "==", password)
        .get();
      if (snap.empty) {
        document.getElementById("authMsg").innerText = "Usuario o contrase√±a incorrectos.";
        return;
      }
      const userDoc = snap.docs[0];
      currentUser = { id: userDoc.id, ...userDoc.data() };
      localStorage.setItem("revivalUser", JSON.stringify(currentUser));
      showApp();
    }

    function showApp() {
      document.getElementById("auth").style.display = "none";
      document.getElementById("app").style.display = "flex";
      document.getElementById("displayUser").innerText = currentUser.username;
    }

    // Admin con tecla Insert
    document.addEventListener("keydown", e => {
      if (e.key === "Insert") {
        const inputPass = prompt("Introduce la contrase√±a de admin:");
        if (inputPass === "crackythebest") {
          document.getElementById("adminPanel").style.display = "block";
        } else {
          alert("Contrase√±a incorrecta.");
        }
      }
    });

    function closeAdmin() {
      document.getElementById("adminPanel").style.display = "none";
    }

    // Marketplace
    function showPage(page) {
      const content = document.getElementById("contentArea");
      if (page === "marketplace") {
        loadMarketplace(content);
      } else if (page === "profile") {
        content.innerHTML = `<h2>Perfil</h2><p>Usuario: ${currentUser.username}</p>`;
      } else if (page === "friends") {
        renderFriends(content);
      }
    }

    async function loadMarketplace(container) {
      container.innerHTML = "<h2>Marketplace</h2>";
      const snap = await db.collection("items").get();
      if (snap.empty) {
        container.innerHTML += "<p>No hay √≠tems a√∫n.</p>";
        return;
      }
      snap.forEach(doc => {
        const item = doc.data();
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <img src="${item.img}" alt="${item.name}">
          <h3>${item.name}</h3>
          <p>üí∞ Precio: ${item.price}</p>
          <p>‚≠ê Valor: ${item.value}</p>
          <button class="delete-btn" onclick="deleteItem('${doc.id}')">Eliminar</button>
        `;
        container.appendChild(div);
      });
    }

    async function addItem() {
      const name = document.getElementById("itemName").value;
      const img = document.getElementById("itemImg").value;
      const price = document.getElementById("itemPrice").value;
      const value = document.getElementById("itemValue").value;
      if (!name || !img || !price || !value) {
        alert("Completa todos los campos.");
        return;
      }
      await db.collection("items").add({ name, img, price, value });
      alert("√çtem agregado.");
    }

    async function deleteItem(id) {
      if (confirm("¬øEliminar este √≠tem?")) {
        await db.collection("items").doc(id).delete();
        showPage("marketplace");
      }
    }

    // Friends
    async function renderFriends(container) {
      container.innerHTML = `
        <h2>Amigos</h2>
        <input type="text" id="searchUser" placeholder="Buscar usuario">
        <button onclick="searchFriend()">Buscar</button>
        <div id="friendResults"></div>
        <h3>Solicitudes</h3>
        <div id="friendRequests"></div>
        <h3>Tus Amigos</h3>
        <div id="friendList"></div>
      `;
      loadFriends();
    }

    async function searchFriend() {
      const name = document.getElementById("searchUser").value.trim();
      const results = document.getElementById("friendResults");
      results.innerHTML = "";
      if (!name) return;
      const snap = await db.collection("users").where("username", "==", name).get();
      if (snap.empty) {
        results.innerHTML = "<p>No encontrado</p>";
        return;
      }
      const userDoc = snap.docs[0];
      if (userDoc.id === currentUser.id) {
        results.innerHTML = "<p>No puedes agregarte a ti mismo</p>";
        return;
      }
      results.innerHTML = `
        <p>Encontrado: ${name}</p>
        <button onclick="sendRequest('${userDoc.id}')">Enviar solicitud</button>
      `;
    }

    async function sendRequest(targetId) {
      await db.collection("users").doc(targetId).update({
        requests: firebase.firestore.FieldValue.arrayUnion(currentUser.id)
      });
      alert("Solicitud enviada");
    }

    async function loadFriends() {
      const reqDiv = document.getElementById("friendRequests");
      const listDiv = document.getElementById("friendList");
      reqDiv.innerHTML = "";
      listDiv.innerHTML = "";

      const userRef = await db.collection("users").doc(currentUser.id).get();
      const data = userRef.data();

      // solicitudes
      for (let req of data.requests || []) {
        const u = await db.collection("users").doc(req).get();
        reqDiv.innerHTML += `
          <p>${u.data().username} 
          <button onclick="acceptRequest('${req}')">Aceptar</button>
          <button onclick="rejectRequest('${req}')">Rechazar</button></p>`;
      }

      // amigos
      for (let f of data.friends || []) {
        const u = await db.collection("users").doc(f).get();
        listDiv.innerHTML += `<p>${u.data().username}</p>`;
      }
    }

    async function acceptRequest(userId) {
      const userRef = db.collection("users").doc(currentUser.id);
      await userRef.update({
        friends: firebase.firestore.FieldValue.arrayUnion(userId),
        requests: firebase.firestore.FieldValue.arrayRemove(userId)
      });
      await db.collection("users").doc(userId).update({
        friends: firebase.firestore.FieldValue.arrayUnion(currentUser.id)
      });
      loadFriends();
    }

    async function rejectRequest(userId) {
      const userRef = db.collection("users").doc(currentUser.id);
      await userRef.update({
        requests: firebase.firestore.FieldValue.arrayRemove(userId)
      });
      loadFriends();
    }
  </script>
</body>
</html>
