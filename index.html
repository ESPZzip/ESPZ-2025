<!DOCTYPE html>
<html>
<head>
  <title>ESP:Z - Home</title>
  <style>
    body {font-family: Arial; display:flex; margin:0;}
    #sidebar {width:200px; background:#222; color:white; padding:10px;}
    #sidebar button {width:100%; margin:5px 0; padding:8px; border:none; border-radius:8px; cursor:pointer;}
    #content {flex:1; padding:20px;}
    .item {border:1px solid #ccc; padding:10px; margin:5px; display:inline-block; width:150px; vertical-align:top;}
    .tag {font-size:12px; padding:2px 4px; border-radius:4px; display:inline-block; margin-bottom:5px;}
    #adminPanel {display:none; position:fixed; top:10%; left:25%; right:25%; background:#fff; padding:20px; border:2px solid #000; z-index:1000;}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body>
  <div id="sidebar">
    <h3>Menu</h3>
    <button onclick="loadMarket()">Marketplace</button>
    <button onclick="loadProfile()">Profile</button>
    <button onclick="loadFriends()">Friends</button>
    <button onclick="loadChat()">Chat</button>
    <div id="extraButtons"></div>
  </div>

  <div id="content">
    <h2>Login / Register</h2>
    <input id="username" placeholder="Usuario"><br>
    <input id="password" type="password" placeholder="Contrase√±a"><br>
    <button onclick="register()">Registrar</button>
    <button onclick="login()">Login</button>
  </div>

  <!-- üîπ Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <input id="itemName" placeholder="Nombre del Item"><br>
    <input id="itemImg" placeholder="URL Imagen"><br>
    <input id="itemPrice" placeholder="Precio"><br>
    <input id="itemValue" placeholder="Valor"><br>
    <input id="itemStock" placeholder="Stock"><br>
    <input id="itemTagText" placeholder="Tag (opcional)"><br>
    <input id="itemTagColor" placeholder="Color Tag (ej: red)"><br>
    <input id="itemTagBg" placeholder="Fondo Tag (ej: yellow)"><br>
    <input id="itemAddedBy" placeholder="Subido por"><br>
    <button onclick="addItem()">Agregar Item</button>
    <button onclick="closeAdmin()">Cerrar</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { 
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser=null;

    // üîπ Registrar
    async function register(){
      const u=document.getElementById("username").value;
      const p=document.getElementById("password").value;
      if(!u||!p) return alert("Completa los campos");
      const ref=doc(db,"users",u);
      const snap=await getDoc(ref);
      if(snap.exists()){alert("Usuario ya existe");return;}
      await setDoc(ref,{username:u,password:p,robux:100});
      localStorage.setItem("currentUser",u);
      currentUser=u;
      startApp();
    }

    // üîπ Login
    async function login(){
      const u=document.getElementById("username").value;
      const p=document.getElementById("password").value;
      const ref=doc(db,"users",u);
      const snap=await getDoc(ref);
      if(!snap.exists()){alert("No existe");return;}
      if(snap.data().password!==p){alert("Contrase√±a incorrecta");return;}
      localStorage.setItem("currentUser",u);
      currentUser=u;
      startApp();
    }

    // üîπ Cerrar sesi√≥n
    function logout(){
      localStorage.removeItem("currentUser");
      location.reload();
    }

    // üîπ Inicializar app
    function startApp(){
      document.getElementById("content").innerHTML="<h2>Bienvenido "+currentUser+"</h2>";
      const extra=document.getElementById("extraButtons");
      extra.innerHTML="";
      if(currentUser==="ROBLOX"){
        extra.innerHTML+=`<button onclick="loadGiveaways()">Giveaways</button>`;
      }
      extra.innerHTML+=`<button onclick="logout()">Cerrar Sesi√≥n</button>`;
      extra.innerHTML+=`<button onclick="loadTrades()">Trades</button>`; // üîπ Nuevo bot√≥n
    }

    // üîπ Marketplace
    async function loadMarket(){
      const snap=await getDocs(collection(db,"items"));
      const cont=document.getElementById("content");
      cont.innerHTML="<h2>Marketplace</h2>";
      snap.forEach(docSnap=>{
        const item=docSnap.data();
        cont.innerHTML+=`
          <div class="item ${item.stock===0?'agotado':''}">
            ${item.tag?`<div class="tag" style="color:${item.tag.color};background:${item.tag.bg};">${item.tag.text}</div>`:""}
            <img src="${item.img}" width="80"><br>
            <b>${item.name}</b><br>
            üí∞ ${item.price} | ‚≠ê ${item.value}<br>
            Stock: ${item.stock}<br>
            üìå Subido por: <b>${item.addedBy || "Desconocido"}</b><br>
            <button onclick="buyItem('${docSnap.id}')">Comprar</button>
          </div>`;
      });
    }

    // üîπ Comprar
    async function buyItem(id){
      const ref=doc(db,"items",id);
      const snap=await getDoc(ref);
      if(!snap.exists()) return;
      const item=snap.data();
      if(item.stock<=0) return alert("NO HAY STOCK");
      const userRef=doc(db,"users",currentUser);
      const user=await getDoc(userRef);
      if(user.data().robux<item.price) return alert("No tienes Robux");
      await updateDoc(userRef,{robux:user.data().robux-item.price});
      await updateDoc(ref,{stock:item.stock-1});
      await addDoc(collection(userRef,"inventory"),item);
      alert("Comprado!");
      loadMarket();
    }

    // üîπ Admin
    async function addItem(){
      const name=document.getElementById("itemName").value;
      const img=document.getElementById("itemImg").value;
      const price=parseInt(document.getElementById("itemPrice").value);
      const value=parseInt(document.getElementById("itemValue").value);
      const stock=parseInt(document.getElementById("itemStock").value);
      const tag={text:document.getElementById("itemTagText").value,color:document.getElementById("itemTagColor").value,bg:document.getElementById("itemTagBg").value};
      const addedBy=document.getElementById("itemAddedBy").value || currentUser;
      await setDoc(doc(db,"items",name),{name,img,price,value,stock,tag,addedBy});
      alert("Item agregado");
    }

    function closeAdmin(){document.getElementById("adminPanel").style.display="none";}

    // üîπ Trades
    async function loadTrades(){
      const usersSnap=await getDocs(collection(db,"users"));
      let html="<h2>Trades</h2>";
      html+="<h3>Enviar Trade</h3>";
      usersSnap.forEach(docSnap=>{
        if(docSnap.id!==currentUser){
          html+=`${docSnap.id} <button onclick="openTrade('${docSnap.id}')">Tradear</button><br>`;
        }
      });

      html+="<h3>Trades Recibidos</h3><div id='receivedTrades'></div>";
      document.getElementById("content").innerHTML=html;
      loadReceivedTrades();
    }

    async function openTrade(target){
      let html=`<h2>Enviar Trade a ${target}</h2>`;
      html+=`<h3>Tu inventario (elige lo que ofreces)</h3><div id="tradeInventory"></div>`;
      html+=`<button onclick="sendTrade('${target}')">Enviar Trade</button>`;
      document.getElementById("content").innerHTML=html;

      const invSnap=await getDocs(collection(doc(db,"users",currentUser),"inventory"));
      const invDiv=document.getElementById("tradeInventory");
      if(invSnap.empty) invDiv.innerHTML="<p>No tienes items.</p>";
      else {
        invSnap.forEach(doc=>{
          const item=doc.data();
          invDiv.innerHTML+=`
            <label>
              <input type="checkbox" class="tradeItem" value="${doc.id}">
              ${item.name} ‚≠ê${item.value}
            </label><br>`;
        });
      }
    }

    async function sendTrade(target){
      const checkboxes=document.querySelectorAll(".tradeItem:checked");
      if(checkboxes.length===0) return alert("Selecciona al menos un item");
      let items=[];
      for(let cb of checkboxes){
        const snap=await getDoc(doc(db,"users",currentUser,"inventory",cb.value));
        if(snap.exists()) items.push(snap.data());
      }
      await addDoc(collection(db,"users",target,"trades"),{from:currentUser,items,timestamp:Date.now()});
      alert("Trade enviado a "+target);
      loadTrades();
    }

    async function loadReceivedTrades(){
      const snap=await getDocs(collection(db,"users",currentUser,"trades"));
      const div=document.getElementById("receivedTrades");
      if(snap.empty){div.innerHTML="<p>No tienes trades.</p>"; return;}
      snap.forEach(docSnap=>{
        const trade=docSnap.data();
        let itemsHtml="";
        trade.items.forEach(it=>{
          itemsHtml+=`${it.name} ‚≠ê${it.value}<br>`;
        });
        div.innerHTML+=`
          <div class="trade">
            <b>De: ${trade.from}</b><br>
            Items: <br>${itemsHtml}
            <button onclick="acceptTrade('${docSnap.id}','${trade.from}')">Aceptar</button>
            <button onclick="rejectTrade('${docSnap.id}')">Rechazar</button>
          </div><br>`;
      });
    }

    async function acceptTrade(tradeId,from){
      const ref=doc(db,"users",currentUser,"trades",tradeId);
      const snap=await getDoc(ref);
      if(!snap.exists()) return;
      const trade=snap.data();
      for(let it of trade.items){
        await addDoc(collection(doc(db,"users",currentUser),"inventory"),it);
      }
      await deleteDoc(ref);
      alert("Trade aceptado");
      loadTrades();
    }

    async function rejectTrade(tradeId){
      await deleteDoc(doc(db,"users",currentUser,"trades",tradeId));
      alert("Trade rechazado");
      loadTrades();
    }

    // üîπ Admin con tecla Insert
    document.addEventListener("keydown",function(e){
      if(e.key==="Insert" && currentUser==="ROBLOX"){
        const panel=document.getElementById("adminPanel");
        panel.style.display=panel.style.display==="block"?"none":"block";
      }
    });

    // üîπ Mantener login al refrescar
    window.onload=function(){
      const u=localStorage.getItem("currentUser");
      if(u){currentUser=u;startApp();}
    }
  </script>
</body>
</html>
