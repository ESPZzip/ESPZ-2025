<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Roblox Revival</title>
  <style>
    body { font-family: Arial; background:#eee; margin:0; }
    header { background:#444; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    #robuxDisplay { font-weight:bold; }
    #main { display:flex; }
    nav { width:150px; background:#ddd; padding:10px; display:flex; flex-direction:column; gap:10px; }
    nav button { padding:8px; cursor:pointer; }
    #content { flex:1; padding:20px; }
    .item { border:1px solid #aaa; padding:10px; margin:10px; border-radius:5px; background:white; display:inline-block; text-align:center; }
    #adminPanel { display:none; position:fixed; top:50px; left:50px; background:white; border:2px solid black; padding:20px; z-index:999; }
    .agotado { opacity:0.5; }
    .tag { padding:2px 6px; border-radius:6px; font-size:12px; font-weight:bold; display:inline-block; margin-bottom:4px; }
    .chatBox { border:1px solid #aaa; padding:10px; height:200px; overflow-y:auto; background:white; }
    .chatMsg { margin:4px 0; }
  </style>
</head>
<body>
<header>
  <div id="userDisplay">No logueado</div>
  <div id="robuxDisplay" style="display:none;">üí∞ <span id="robuxCount">0</span></div>
</header>

<div id="auth">
  <h2>Login / Registro</h2>
  <input id="username" placeholder="Usuario"><br>
  <input id="password" type="password" placeholder="Contrase√±a"><br>
  <button onclick="register()">Registrar</button>
  <button onclick="login()">Login</button>
</div>

<div id="main" style="display:none;">
  <nav>
    <button onclick="loadMarket()">Marketplace</button>
    <button onclick="loadProfile()">Profile</button>
    <button onclick="loadFriends()">Friends</button>
    <button onclick="loadChat()">Chat</button>
  </nav>
  <div id="content"></div>
</div>

<!-- üîπ Admin Panel -->
<div id="adminPanel">
  <h2>Admin Panel</h2>
  <h3>‚ûï Agregar Item</h3>
  <input id="itemName" placeholder="Nombre item"><br>
  <input id="itemImg" placeholder="URL imagen"><br>
  <input id="itemPrice" placeholder="Precio"><br>
  <input id="itemValue" placeholder="Valor"><br>
  <input id="itemStock" placeholder="Stock"><br>
  <input id="itemTagText" placeholder="Tag texto (opcional)"><br>
  <input id="itemTagColor" placeholder="Color tag (ej: red, blue, #ff0000)"><br>
  <input id="itemTagBg" placeholder="Fondo tag (ej: yellow, #00ff00)"><br>
  <button onclick="addItem()">Agregar Item</button>
  <div id="adminItems"></div>
  <hr>
  <h3>üéÅ Regalar Robux</h3>
  <input id="giftUser" placeholder="Usuario destino"><br>
  <input id="giftRobux" placeholder="Cantidad"><br>
  <button onclick="giftRobux()">Enviar Robux</button>
  <hr>
  <h3>üéÅ Regalar Item</h3>
  <input id="giftUserItem" placeholder="Usuario destino"><br>
  <select id="giftItemSelect"></select><br>
  <button onclick="giftItem()">Enviar Item</button>
  <br><br>
  <button onclick="closeAdmin()">Cerrar</button>
</div>

<!-- üîπ Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = { 
    apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
    authDomain: "pekora-forum.firebaseapp.com",
    projectId: "pekora-forum",
    storageBucket: "pekora-forum.firebasestorage.app",
    messagingSenderId: "161910967859",
    appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
    measurementId: "G-BPBTW5KBRK"
  };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore();

  let currentUser=null;

  // üîπ Registro
  async function register(){
    const u=document.getElementById("username").value;
    const p=document.getElementById("password").value;
    if(!u||!p) return alert("Completa todos los campos");
    const ref=db.collection("users").doc(u);
    const doc=await ref.get();
    if(doc.exists) return alert("Usuario ya existe");
    await ref.set({username:u,password:p,robux:100,friends:[],requests:[]});
    alert("Registrado!");
    localStorage.setItem("currentUser",u);
    currentUser=u; startApp();
  }

  // üîπ Login
  async function login(){
    const u=document.getElementById("username").value;
    const p=document.getElementById("password").value;
    const ref=db.collection("users").doc(u);
    const doc=await ref.get();
    if(!doc.exists) return alert("No existe");
    if(doc.data().password!==p) return alert("Contrase√±a incorrecta");
    localStorage.setItem("currentUser",u);
    currentUser=u; startApp();
  }

  function startApp(){
    document.getElementById("auth").style.display="none";
    document.getElementById("main").style.display="flex";
    const userDisplay=currentUser==="ROBLOX" 
      ? `${currentUser} <span style="color:red;font-weight:bold;">[ADMIN]</span>` 
      : currentUser;
    document.getElementById("userDisplay").innerHTML=userDisplay;
    document.getElementById("robuxDisplay").style.display="block";
    loadMarket();
    updateRobux();
  }

  async function updateRobux(){
    const snap=await db.collection("users").doc(currentUser).get();
    if(snap.exists){
      document.getElementById("robuxCount").innerText=snap.data().robux;
    }
  }

  // üîπ Marketplace
  async function loadMarket(){
    const snap=await db.collection("items").get();
    const cont=document.getElementById("content");
    cont.innerHTML="<h2>Marketplace</h2>";
    snap.forEach(doc=>{
      const item=doc.data();
      cont.innerHTML+=`
        <div class="item ${item.stock===0?'agotado':''}">
          ${item.tag?`<div class="tag" style="color:${item.tag.color};background:${item.tag.bg};">${item.tag.text}</div>`:""}
          <img src="${item.img}" width="80"><br>
          <b>${item.name}</b><br>
          üí∞ ${item.price} | ‚≠ê ${item.value}<br>
          Stock: ${item.stock}<br>
          <button onclick="buyItem('${doc.id}')">Comprar</button>
        </div>`;
    });
  }

  // üîπ Comprar
  async function buyItem(id){
    const ref=db.collection("items").doc(id);
    const snap=await ref.get();
    if(!snap.exists) return;
    const item=snap.data();
    if(item.stock<=0){alert("NO HAY STOCK"); return;}
    const userRef=db.collection("users").doc(currentUser);
    const uData=(await userRef.get()).data();
    if(uData.robux<item.price){alert("No tienes Robux"); return;}
    await userRef.update({robux:uData.robux-item.price});
    await userRef.collection("inventory").doc(item.name).set(item);
    await ref.update({stock:item.stock-1});
    alert("Comprado!");
    updateRobux(); loadMarket();
  }

  // üîπ Perfil
  async function loadProfile(){
    const cont=document.getElementById("content");
    cont.innerHTML="<h2>Perfil</h2><div id='inv'></div>";
    const invSnap=await db.collection("users").doc(currentUser).collection("inventory").get();
    const invDiv=document.getElementById("inv");
    if(invSnap.empty) invDiv.innerHTML="<p>Sin items</p>";
    else invSnap.forEach(doc=>{
      const item=doc.data();
      invDiv.innerHTML+=`
        <div class="item">
          ${item.tag?`<div class="tag" style="color:${item.tag.color};background:${item.tag.bg};">${item.tag.text}</div>`:""}
          <img src="${item.img}" width="80"><br>
          <b>${item.name}</b><br>
          ‚≠ê ${item.value}
        </div>`;
    });
  }

  // üîπ Friends
  async function loadFriends(){
    const cont=document.getElementById("content");
    cont.innerHTML=`<h2>Friends</h2>
      <input id="friendSearch" placeholder="Buscar usuario">
      <button onclick="searchFriend()">Buscar</button>
      <div id="friendResult"></div>
      <hr><h3>Solicitudes</h3><div id="reqs"></div>
      <hr><h3>Tus Amigos</h3><div id="myfriends"></div>`;
    showRequests(); showFriends();
  }

  async function searchFriend(){
    const name=document.getElementById("friendSearch").value;
    if(!name) return;
    const ref=db.collection("users").doc(name);
    const snap=await ref.get();
    const res=document.getElementById("friendResult");
    if(!snap.exists){res.innerHTML="<p>No existe</p>"; return;}
    if(name===currentUser){res.innerHTML="<p>No puedes agregarte</p>"; return;}
    res.innerHTML=`<p>${name} <button onclick="addFriend('${name}')">A√±adir</button></p>`;
  }

  async function addFriend(name){
    const ref=db.collection("users").doc(name);
    const snap=await ref.get();
    if(!snap.exists) return;
    const reqs=snap.data().requests||[];
    if(reqs.includes(currentUser)) return alert("Ya enviado");
    await ref.update({requests:[...reqs,currentUser]});
    alert("Solicitud enviada");
  }

  async function showRequests(){
    const ref=db.collection("users").doc(currentUser);
    const snap=await ref.get();
    const reqs=snap.data().requests||[];
    const div=document.getElementById("reqs");
    div.innerHTML="";
    reqs.forEach(r=>{
      div.innerHTML+=`<p>${r} 
        <button onclick="acceptReq('${r}')">Aceptar</button>
        <button onclick="rejectReq('${r}')">Rechazar</button></p>`;
    });
  }

  async function acceptReq(name){
    const ref=db.collection("users").doc(currentUser);
    const snap=await ref.get();
    const data=snap.data();
    const newReqs=(data.requests||[]).filter(r=>r!==name);
    const newFriends=[...(data.friends||[]),name];
    await ref.update({requests:newReqs,friends:newFriends});
    const fref=db.collection("users").doc(name);
    const fsnap=await fref.get();
    const fdata=fsnap.data();
    await fref.update({friends:[...(fdata.friends||[]),currentUser]});
    showRequests(); showFriends();
  }

  async function rejectReq(name){
    const ref=db.collection("users").doc(currentUser);
    const snap=await ref.get();
    const data=snap.data();
    const newReqs=(data.requests||[]).filter(r=>r!==name);
    await ref.update({requests:newReqs});
    showRequests();
  }

  async function showFriends(){
    const snap=await db.collection("users").doc(currentUser).get();
    const friends=snap.data().friends||[];
    const div=document.getElementById("myfriends");
    div.innerHTML="";
    friends.forEach(f=>{
      div.innerHTML+=`<p>${f} <button onclick="openChat('${f}')">Chatear</button></p>`;
    });
  }

  // üîπ Chat
  function loadChat(){
    const cont=document.getElementById("content");
    cont.innerHTML="<h2>Chat</h2><div id='chatList'></div>";
    showFriendsChat();
  }

  async function showFriendsChat(){
    const snap=await db.collection("users").doc(currentUser).get();
    const friends=snap.data().friends||[];
    const div=document.getElementById("chatList");
    if(!friends.length){div.innerHTML="<p>No tienes amigos</p>"; return;}
    friends.forEach(f=>{
      div.innerHTML+=`<p>${f} <button onclick="openChat('${f}')">Chatear</button></p>`;
    });
  }

  function openChat(friend){
    const cont=document.getElementById("content");
    cont.innerHTML=`<h2>Chat con ${friend}</h2>
      <div id="chatBox" class="chatBox"></div>
      <input id="chatMsg" placeholder="Mensaje">
      <button onclick="sendMsg('${friend}')">Enviar</button>
      <br><button onclick="loadChat()">‚¨Ö Volver</button>`;
    listenChat(friend);
  }

  function chatId(u1,u2){ return [u1,u2].sort().join("_"); }

  function listenChat(friend){
    const box=document.getElementById("chatBox");
    db.collection("chats").doc(chatId(currentUser,friend))
      .collection("msgs").orderBy("time")
      .onSnapshot(snap=>{
        box.innerHTML="";
        snap.forEach(doc=>{
          const m=doc.data();
          box.innerHTML+=`<div class="chatMsg"><b>${m.from}:</b> ${m.text}</div>`;
        });
        box.scrollTop=box.scrollHeight;
      });
  }

  async function sendMsg(friend){
    const msg=document.getElementById("chatMsg").value;
    if(!msg) return;
    const cid=chatId(currentUser,friend);
    await db.collection("chats").doc(cid).collection("msgs").add({
      from:currentUser,text:msg,time:Date.now()
    });
    document.getElementById("chatMsg").value="";
  }

  // üîπ Admin Panel funciones
  async function addItem(){
    const name=document.getElementById("itemName").value;
    const img=document.getElementById("itemImg").value;
    const price=parseInt(document.getElementById("itemPrice").value);
    const value=parseInt(document.getElementById("itemValue").value);
    const stock=parseInt(document.getElementById("itemStock").value);
    const tagText=document.getElementById("itemTagText").value.trim();
    const tagColor=document.getElementById("itemTagColor").value.trim();
    const tagBg=document.getElementById("itemTagBg").value.trim();

    const data={name,img,price,value,stock};
    if(tagText) data.tag={text:tagText,color:tagColor||"black",bg:tagBg||"transparent"};

    await db.collection("items").doc(name).set(data);
    alert("Item agregado");
    loadAdmin();
  }

  function closeAdmin(){document.getElementById("adminPanel").style.display="none";}

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Insert" && currentUser==="ROBLOX"){
      const panel=document.getElementById("adminPanel");
      if(panel.style.display==="block"){closeAdmin();} else {loadAdmin();}
    }
  });

  async function loadAdmin(){
    document.getElementById("adminPanel").style.display="block";
    const sel=document.getElementById("giftItemSelect");
    sel.innerHTML="";
    const snap=await db.collection("items").get();
    snap.forEach(d=>{
      const it=d.data();
      sel.innerHTML+=`<option value="${it.name}">${it.name}</option>`;
    });
  }

  async function giftRobux(){
    const user=document.getElementById("giftUser").value;
    const amt=parseInt(document.getElementById("giftRobux").value);
    if(!user||!amt) return;
    const ref=db.collection("users").doc(user);
    const snap=await ref.get();
    if(!snap.exists) return alert("No existe");
    const data=snap.data();
    await ref.update({robux:data.robux+amt});
    alert("Robux enviados");
  }

  async function giftItem(){
    const user=document.getElementById("giftUserItem").value;
    const itemName=document.getElementById("giftItemSelect").value;
    if(!user||!itemName) return;
    const itemSnap=await db.collection("items").doc(itemName).get();
    if(!itemSnap.exists) return;
    const item=itemSnap.data();
    await db.collection("users").doc(user).collection("inventory").doc(itemName).set(item);
    alert("Item enviado");
  }

  // üîπ Mantener login
  window.onload=function(){
    const u=localStorage.getItem("currentUser");
    if(u){currentUser=u;startApp();}
  }
</script>
</body>
</html>
