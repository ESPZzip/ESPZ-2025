<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Roblox Revival</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f0f0f0; }
    header { background:#222; color:#fff; padding:10px; text-align:center; }
    #container { display:flex; height:100vh; }
    #sidebar { width:200px; background:#333; color:#fff; padding:15px; display:flex; flex-direction:column; }
    #sidebar button { margin:5px 0; padding:10px; border:none; border-radius:8px; cursor:pointer; background:#444; color:white; transition:0.3s; }
    #sidebar button:hover { background:#666; }
    #main { flex:1; padding:20px; overflow-y:auto; }
    .hidden { display:none; }
    .btn { padding:8px 12px; border:none; border-radius:8px; cursor:pointer; }
    .btn-buy { background:#4CAF50; color:#fff; }
    .btn-delete { background:#e63946; color:#fff; }
    .robux { position:absolute; top:10px; right:20px; font-weight:bold; color:#333; }
    .item { border:1px solid #ccc; padding:10px; margin:10px; border-radius:10px; background:white; display:inline-block; width:200px; text-align:center; }
    #adminPanel { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:2px solid #333; padding:20px; border-radius:12px; display:none; z-index:1000; }
  </style>
</head>
<body>
  <header>
    <h1>Roblox Revival</h1>
    <div id="robuxDisplay" class="robux hidden">üí∞ <span id="robuxAmount">0</span></div>
  </header>
  <div id="container">
    <div id="sidebar" class="hidden">
      <button onclick="showSection('marketplace')">Marketplace</button>
      <button onclick="showSection('profile')">Profile</button>
      <button onclick="showSection('friends')">Friends</button>
      <button onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
    <div id="main">
      <!-- Login & Register -->
      <div id="authSection">
        <h2>Login</h2>
        <input id="logUsername" placeholder="Usuario"><br>
        <input id="logPassword" type="password" placeholder="Contrase√±a"><br>
        <button onclick="login()">Entrar</button>
        <h2>Registro</h2>
        <input id="regUsername" placeholder="Usuario"><br>
        <input id="regPassword" type="password" placeholder="Contrase√±a"><br>
        <button onclick="register()">Registrar</button>
      </div>

      <div id="contentArea" class="hidden"></div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h3>Admin Panel</h3>
    <input id="itemName" placeholder="Nombre item"><br>
    <input id="itemImg" placeholder="URL Imagen"><br>
    <input id="itemPrice" type="number" placeholder="Precio"><br>
    <input id="itemValue" type="number" placeholder="Valor"><br>
    <button onclick="addItem()">Agregar Item</button>
    <button onclick="closeAdmin()">Cerrar</button>
  </div>

  <script>
    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;

    // üîπ Registro
    async function register(){
      const user = document.getElementById("regUsername").value.trim();
      const pass = document.getElementById("regPassword").value;
      if(!user || !pass) return alert("Completa los campos");

      const ref = db.collection("users").doc(user);
      const docSnap = await ref.get();
      if(docSnap.exists){ alert("El usuario ya existe"); return; }

      await ref.set({ username:user, password:pass, robux:500 });
      currentUser = user;
      localStorage.setItem("loggedUser", user);
      alert("Registro exitoso");
      loadUserData();
    }

    // üîπ Login
    async function login(){
      const user = document.getElementById("logUsername").value.trim();
      const pass = document.getElementById("logPassword").value;
      if(!user || !pass) return alert("Completa los campos");

      const ref = db.collection("users").doc(user);
      const docSnap = await ref.get();
      if(!docSnap.exists){ alert("Usuario no encontrado"); return; }
      if(docSnap.data().password !== pass){ alert("Contrase√±a incorrecta"); return; }

      currentUser = user;
      localStorage.setItem("loggedUser", user);
      alert("Bienvenido " + user);
      loadUserData();
    }

    // üîπ Cargar sesi√≥n
    async function loadUserData(){
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("sidebar").classList.remove("hidden");
      document.getElementById("contentArea").classList.remove("hidden");
      document.getElementById("robuxDisplay").classList.remove("hidden");
      showSection("marketplace");
      updateRobux();
    }

    async function updateRobux(){
      if(!currentUser) return;
      const docSnap = await db.collection("users").doc(currentUser).get();
      if(docSnap.exists){
        document.getElementById("robuxAmount").textContent = docSnap.data().robux;
      }
    }

    // üîπ Logout
    function logout(){
      currentUser=null;
      localStorage.removeItem("loggedUser");
      location.reload();
    }

    // üîπ Secciones
    function showSection(section){
      if(section==="marketplace") loadMarketplace();
      if(section==="profile") loadProfile();
      if(section==="friends") loadFriends();
    }

    // üîπ Marketplace
    async function loadMarketplace(){
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h2>Marketplace</h2>";
      const snap = await db.collection("items").get();
      snap.forEach(doc=>{
        const item=doc.data();
        content.innerHTML += `
          <div class="item">
            <img src="${item.img}" width="100"><br>
            <b>${item.name}</b><br>
            üí∞ ${item.price} - ‚≠ê ${item.value}<br>
            <button class="btn btn-buy" onclick="buyItem('${doc.id}', ${item.price})">Comprar</button>
            <button class="btn btn-delete" onclick="deleteItem('${doc.id}')">Eliminar</button>
          </div>`;
      });
    }

    async function buyItem(id, price){
      const userRef = db.collection("users").doc(currentUser);
      const doc = await userRef.get();
      let robux = doc.data().robux;
      if(robux<price){ alert("No tienes suficientes Robux"); return; }
      await userRef.update({ robux: robux-price });
      updateRobux();
      alert("¬°Compra realizada!");
    }

    async function addItem(){
      const name=document.getElementById("itemName").value;
      const img=document.getElementById("itemImg").value;
      const price=parseInt(document.getElementById("itemPrice").value);
      const value=parseInt(document.getElementById("itemValue").value);
      if(!name||!img||!price) return;
      await db.collection("items").add({name,img,price,value});
      closeAdmin();
      loadMarketplace();
    }

    async function deleteItem(id){
      await db.collection("items").doc(id).delete();
      loadMarketplace();
    }

    // üîπ Profile
    async function loadProfile(){
      const snap = await db.collection("users").doc(currentUser).get();
      const user=snap.data();
      document.getElementById("contentArea").innerHTML=`
        <h2>Perfil de ${user.username}</h2>
        <p>Robux: ${user.robux}</p>
      `;
    }

    // üîπ Friends
    async function loadFriends(){
      const content=document.getElementById("contentArea");
      content.innerHTML=`
        <h2>üë• Amigos</h2>
        <div>
          <input type="text" id="searchUser" placeholder="Buscar usuario..." style="width:250px;padding:8px;">
          <button class="btn" style="background:#4cc9f0;" onclick="searchUser()">Buscar</button>
        </div>
        <div id="searchResults" style="margin-top:15px;"></div>
        <h3>Solicitudes de amistad</h3>
        <div id="friendRequests"></div>
        <h3>Mis Amigos</h3>
        <div id="friendsList"></div>
      `;
      loadFriendRequests();
      loadFriendsList();
    }

    async function searchUser(){
      const query=document.getElementById("searchUser").value.trim();
      if(!query) return;
      const snap=await db.collection("users").doc(query).get();
      const results=document.getElementById("searchResults");
      if(!snap.exists){ results.innerHTML="<p>No se encontr√≥ ning√∫n usuario</p>"; return; }
      if(query===currentUser){ results.innerHTML="<p>No puedes agregarte a ti mismo üòÖ</p>"; return; }
      results.innerHTML=`
        <div class="item" style="width:200px;">
          <b>${snap.id}</b><br>
          <button class="btn btn-buy" onclick="sendFriendRequest('${snap.id}')">Agregar amigo</button>
        </div>`;
    }

    async function sendFriendRequest(toUser){
      const reqRef=db.collection("users").doc(toUser).collection("friendRequests").doc(currentUser);
      const already=await reqRef.get();
      if(already.exists){ alert("Ya enviaste una solicitud"); return; }
      await reqRef.set({from:currentUser,date:new Date()});
      alert("Solicitud enviada a "+toUser);
    }

    async function loadFriendRequests(){
      const reqs=await db.collection("users").doc(currentUser).collection("friendRequests").get();
      const container=document.getElementById("friendRequests");
      if(reqs.empty){ container.innerHTML="<p>No tienes solicitudes</p>"; return; }
      let html=""; reqs.forEach(doc=>{
        html+=`
        <div class="item" style="width:200px;">
          <b>${doc.id}</b><br>
          <button class="btn btn-buy" onclick="acceptFriend('${doc.id}')">Aceptar</button>
          <button class="btn btn-delete" onclick="rejectFriend('${doc.id}')">Rechazar</button>
        </div>`;
      });
      container.innerHTML=html;
    }

    async function acceptFriend(fromUser){
      const userRef=db.collection("users").doc(currentUser);
      const otherRef=db.collection("users").doc(fromUser);
      await userRef.collection("friends").doc(fromUser).set({username:fromUser});
      await otherRef.collection("friends").doc(currentUser).set({username:currentUser});
      await userRef.collection("friendRequests").doc(fromUser).delete();
      loadFriendRequests(); loadFriendsList();
    }

    async function rejectFriend(fromUser){
      await db.collection("users").doc(currentUser).collection("friendRequests").doc(fromUser).delete();
      loadFriendRequests();
    }

    async function loadFriendsList(){
      const friendsSnap=await db.collection("users").doc(currentUser).collection("friends").get();
      const container=document.getElementById("friendsList");
      if(friendsSnap.empty){ container.innerHTML="<p>No tienes amigos</p>"; return; }
      let html=""; friendsSnap.forEach(doc=>{ html+=`<div class="item" style="width:200px;"><b>${doc.id}</b></div>`; });
      container.innerHTML=html;
    }

    // üîπ Admin Panel
    document.addEventListener("keydown",function(e){
      if(e.key==="Insert"){ 
        const pass=prompt("Contrase√±a del Admin:");
        if(pass==="crackythebest"){ document.getElementById("adminPanel").style.display="block"; }
      }
    });
    function closeAdmin(){ document.getElementById("adminPanel").style.display="none"; }

    // Mantener sesi√≥n
    window.onload=()=>{
      const saved=localStorage.getItem("loggedUser");
      if(saved){ currentUser=saved; loadUserData(); }
    }
  </script>
</body>
</html>
