<!DOCTYPE html>
<html>
<head>
  <title>TEST</title>
  <style>
    body {font-family: Arial; display:flex; margin:0;}
    #sidebar {width:200px; background:#222; color:white; padding:10px;}
    #sidebar button {width:100%; margin:5px 0; padding:8px; border:none; border-radius:8px; cursor:pointer;}
    #content {flex:1; padding:20px;}
    .item {border:1px solid #ccc; padding:10px; margin:5px; display:inline-block; width:150px; vertical-align:top;}
    .tag {font-size:12px; padding:2px 4px; border-radius:4px; display:inline-block; margin-bottom:5px;}
    #adminPanel {display:none; position:fixed; top:10%; left:25%; right:25%; background:#fff; padding:20px; border:2px solid #000; z-index:1000;}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body>
  <div id="sidebar">
    <h3>Menu</h3>
    <button onclick="loadMarket()">Marketplace</button>
    <button onclick="loadProfile()">Profile</button>
    <button onclick="loadFriends()">Friends</button>
    <button onclick="loadChat()">Chat</button>
    <div id="extraButtons"></div>
  </div>

  <div id="content">
    <h2>Login / Register</h2>
    <input id="username" placeholder="Usuario"><br>
    <input id="password" type="password" placeholder="Contrase√±a"><br>
    <button onclick="register()">Registrar</button>
    <button onclick="login()">Login</button>
  </div>

  <!-- üîπ Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <input id="itemName" placeholder="Nombre del Item"><br>
    <input id="itemImg" placeholder="URL Imagen"><br>
    <input id="itemPrice" placeholder="Precio"><br>
    <input id="itemValue" placeholder="Valor"><br>
    <input id="itemStock" placeholder="Stock"><br>
    <input id="itemTagText" placeholder="Tag (opcional)"><br>
    <input id="itemTagColor" placeholder="Color Tag (ej: red)"><br>
    <input id="itemTagBg" placeholder="Fondo Tag (ej: yellow)"><br>
    <input id="itemAddedBy" placeholder="Subido por"><br>
    <button onclick="addItem()">Agregar Item</button>
    <button onclick="closeAdmin()">Cerrar</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { 
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser=null;

    // üîπ Registrar
    async function register(){
      const u=document.getElementById("username").value;
      const p=document.getElementById("password").value;
      if(!u||!p) return alert("Completa los campos");
      const ref=doc(db,"users",u);
      const snap=await getDoc(ref);
      if(snap.exists()){alert("Usuario ya existe");return;}
      await setDoc(ref,{username:u,password:p,robux:100});
      localStorage.setItem("currentUser",u);
      currentUser=u;
      startApp();
    }

    // üîπ Login
    async function login(){
      const u=document.getElementById("username").value;
      const p=document.getElementById("password").value;
      const ref=doc(db,"users",u);
      const snap=await getDoc(ref);
      if(!snap.exists()){alert("No existe");return;}
      if(snap.data().password!==p){alert("Contrase√±a incorrecta");return;}
      localStorage.setItem("currentUser",u);
      currentUser=u;
      startApp();
    }

    // üîπ Cerrar sesi√≥n
    function logout(){
      localStorage.removeItem("currentUser");
      location.reload();
    }

    // üîπ Inicializar app
    function startApp(){
      document.getElementById("content").innerHTML="<h2>Bienvenido "+currentUser+"</h2>";
      const extra=document.getElementById("extraButtons");
      extra.innerHTML="";
      if(currentUser==="ROBLOX"){
        extra.innerHTML+=`<button onclick="loadGiveaways()">Giveaways</button>`;
      }
      extra.innerHTML+=`<button onclick="logout()">Cerrar Sesi√≥n</button>`;
      extra.innerHTML+=`<button onclick="loadTrades()">Trades</button>`; // ‚úÖ Nuevo bot√≥n
    }

    // üîπ Marketplace
    async function loadMarket(){
      const snap=await getDocs(collection(db,"items"));
      const cont=document.getElementById("content");
      cont.innerHTML="<h2>Marketplace</h2>";
      snap.forEach(docSnap=>{
        const item=docSnap.data();
        cont.innerHTML+=`
          <div class="item">
            ${item.tag?`<div class="tag" style="color:${item.tag.color};background:${item.tag.bg};">${item.tag.text}</div>`:""}
            <img src="${item.img}" width="80"><br>
            <b>${item.name}</b><br>
            üí∞ ${item.price} | ‚≠ê ${item.value}<br>
            Stock: ${item.stock}<br>
            üìå Subido por: <b>${item.addedBy || "Desconocido"}</b><br>
            <button>Comprar</button>
          </div>`;
      });
    }

    // üîπ Esqueleto Trades
    async function loadTrades(){
      const usersSnap=await getDocs(collection(db,"users"));
      let html="<h2>Trades</h2>";
      html+="<p>Aqu√≠ aparecer√°n todos los jugadores registrados. Podr√°s enviar ofertas y aceptar intercambios.</p>";
      html+="<ul>";
      usersSnap.forEach(docSnap=>{
        if(docSnap.id!==currentUser){
          html+=`<li>${docSnap.id} <button>Iniciar Trade</button></li>`;
        }
      });
      html+="</ul>";
      document.getElementById("content").innerHTML=html;
    }

    // üîπ Admin con tecla Insert
    document.addEventListener("keydown",function(e){
      if(e.key==="Insert" && currentUser==="ROBLOX"){
        const panel=document.getElementById("adminPanel");
        panel.style.display=panel.style.display==="block"?"none":"block";
      }
    });

    // üîπ Mantener login al refrescar
    window.onload=function(){
      const u=localStorage.getItem("currentUser");
      if(u){currentUser=u;startApp();}
    }
  </script>
</body>
</html>
